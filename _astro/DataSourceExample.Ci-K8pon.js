import{c as se,a as qe,R as ze,i as Ot,b as me,d as ye,r as $e,e as at,f as H,g as At,h as Pt,k as nt,l as st,m as vt,n as Gt,o as Bt,p as Zt,q as Qe,s as oe,t as ti,u as U,v as it,w as dt,x as Rt,y as Yt,z as be,A as ei,B as kt,C as ii,D as Xt,Z as ni,E as si,F as re,H as yt,I as Ce,J as oi,K as It,L as ri,M as li,N as Ie,O as Nt,P as jt,Q as ai,S as Wt,T as hi,U as ci,V as di,W as ui,X as Te,Y as Tt,_ as fi,$ as Ft,a0 as Ct,a1 as gi,a2 as _i,a3 as Re,a4 as ke,a5 as xi,a6 as bt,a7 as pi,a8 as Si,a9 as mi,aa as yi,ab as Ci,j as J,G as Ii}from"./GeoMap.Dd81DkbA.js";import{r as Ti}from"./index.C0Tw76Oi.js";const I={BEGIN_GEOMETRY:0,BEGIN_PATH:1,CIRCLE:2,CLOSE_PATH:3,CUSTOM:4,DRAW_CHARS:5,DRAW_IMAGE:6,END_GEOMETRY:7,FILL:8,MOVE_TO_LINE_TO:9,SET_FILL_STYLE:10,SET_STROKE_STYLE:11,STROKE:12},Mt=[I.FILL],ht=[I.STROKE],ut=[I.BEGIN_PATH],we=[I.CLOSE_PATH];class Me{drawCustom(t,e,i,n,o){}drawGeometry(t){}setStyle(t){}drawCircle(t,e,i){}drawFeature(t,e,i){}drawGeometryCollection(t,e,i){}drawLineString(t,e,i){}drawMultiLineString(t,e,i){}drawMultiPoint(t,e,i){}drawMultiPolygon(t,e,i){}drawPoint(t,e,i){}drawPolygon(t,e,i){}drawText(t,e,i){}setFillStrokeStyle(t,e){}setImageStyle(t,e){}setTextStyle(t,e){}}class wt extends Me{constructor(t,e,i,n){super(),this.tolerance=t,this.maxExtent=e,this.pixelRatio=n,this.maxLineWidth=0,this.resolution=i,this.beginGeometryInstruction1_=null,this.beginGeometryInstruction2_=null,this.bufferedMaxExtent_=null,this.instructions=[],this.coordinates=[],this.tmpCoordinate_=[],this.hitDetectionInstructions=[],this.state={}}applyPixelRatio(t){const e=this.pixelRatio;return e==1?t:t.map(function(i){return i*e})}appendFlatPointCoordinates(t,e){const i=this.getBufferedMaxExtent(),n=this.tmpCoordinate_,o=this.coordinates;let s=o.length;for(let r=0,l=t.length;r<l;r+=e)n[0]=t[r],n[1]=t[r+1],se(i,n)&&(o[s++]=n[0],o[s++]=n[1]);return s}appendFlatLineCoordinates(t,e,i,n,o,s){const r=this.coordinates;let l=r.length;const h=this.getBufferedMaxExtent();s&&(e+=n);let a=t[e],c=t[e+1];const u=this.tmpCoordinate_;let d=!0,g,x,_;for(g=e+n;g<i;g+=n)u[0]=t[g],u[1]=t[g+1],_=qe(h,u),_!==x?(d&&(r[l++]=a,r[l++]=c,d=!1),r[l++]=u[0],r[l++]=u[1]):_===ze.INTERSECTING?(r[l++]=u[0],r[l++]=u[1],d=!1):d=!0,a=u[0],c=u[1],x=_;return(o&&d||g===e+n)&&(r[l++]=a,r[l++]=c),l}drawCustomCoordinates_(t,e,i,n,o){for(let s=0,r=i.length;s<r;++s){const l=i[s],h=this.appendFlatLineCoordinates(t,e,l,n,!1,!1);o.push(h),e=l}return e}drawCustom(t,e,i,n,o){this.beginGeometry(t,e,o);const s=t.getType(),r=t.getStride(),l=this.coordinates.length;let h,a,c,u,d;switch(s){case"MultiPolygon":h=t.getOrientedFlatCoordinates(),u=[];const g=t.getEndss();d=0;for(let x=0,_=g.length;x<_;++x){const p=[];d=this.drawCustomCoordinates_(h,d,g[x],r,p),u.push(p)}this.instructions.push([I.CUSTOM,l,u,t,i,ye,o]),this.hitDetectionInstructions.push([I.CUSTOM,l,u,t,n||i,ye,o]);break;case"Polygon":case"MultiLineString":c=[],h=s=="Polygon"?t.getOrientedFlatCoordinates():t.getFlatCoordinates(),d=this.drawCustomCoordinates_(h,0,t.getEnds(),r,c),this.instructions.push([I.CUSTOM,l,c,t,i,me,o]),this.hitDetectionInstructions.push([I.CUSTOM,l,c,t,n||i,me,o]);break;case"LineString":case"Circle":h=t.getFlatCoordinates(),a=this.appendFlatLineCoordinates(h,0,h.length,r,!1,!1),this.instructions.push([I.CUSTOM,l,a,t,i,Ot,o]),this.hitDetectionInstructions.push([I.CUSTOM,l,a,t,n||i,Ot,o]);break;case"MultiPoint":h=t.getFlatCoordinates(),a=this.appendFlatPointCoordinates(h,r),a>l&&(this.instructions.push([I.CUSTOM,l,a,t,i,Ot,o]),this.hitDetectionInstructions.push([I.CUSTOM,l,a,t,n||i,Ot,o]));break;case"Point":h=t.getFlatCoordinates(),this.coordinates.push(h[0],h[1]),a=this.coordinates.length,this.instructions.push([I.CUSTOM,l,a,t,i,void 0,o]),this.hitDetectionInstructions.push([I.CUSTOM,l,a,t,n||i,void 0,o]);break}this.endGeometry(e)}beginGeometry(t,e,i){this.beginGeometryInstruction1_=[I.BEGIN_GEOMETRY,e,0,t,i],this.instructions.push(this.beginGeometryInstruction1_),this.beginGeometryInstruction2_=[I.BEGIN_GEOMETRY,e,0,t,i],this.hitDetectionInstructions.push(this.beginGeometryInstruction2_)}finish(){return{instructions:this.instructions,hitDetectionInstructions:this.hitDetectionInstructions,coordinates:this.coordinates}}reverseHitDetectionInstructions(){const t=this.hitDetectionInstructions;t.reverse();let e;const i=t.length;let n,o,s=-1;for(e=0;e<i;++e)n=t[e],o=n[0],o==I.END_GEOMETRY?s=e:o==I.BEGIN_GEOMETRY&&(n[2]=e,$e(this.hitDetectionInstructions,s,e),s=-1)}setFillStrokeStyle(t,e){const i=this.state;if(t){const n=t.getColor();i.fillPatternScale=n&&typeof n=="object"&&"src"in n?this.pixelRatio:1,i.fillStyle=at(n||H)}else i.fillStyle=void 0;if(e){const n=e.getColor();i.strokeStyle=at(n||At);const o=e.getLineCap();i.lineCap=o!==void 0?o:Pt;const s=e.getLineDash();i.lineDash=s?s.slice():nt;const r=e.getLineDashOffset();i.lineDashOffset=r||st;const l=e.getLineJoin();i.lineJoin=l!==void 0?l:vt;const h=e.getWidth();i.lineWidth=h!==void 0?h:Gt;const a=e.getMiterLimit();i.miterLimit=a!==void 0?a:Bt,i.lineWidth>this.maxLineWidth&&(this.maxLineWidth=i.lineWidth,this.bufferedMaxExtent_=null)}else i.strokeStyle=void 0,i.lineCap=void 0,i.lineDash=null,i.lineDashOffset=void 0,i.lineJoin=void 0,i.lineWidth=void 0,i.miterLimit=void 0}createFill(t){const e=t.fillStyle,i=[I.SET_FILL_STYLE,e];return typeof e!="string"&&i.push(t.fillPatternScale),i}applyStroke(t){this.instructions.push(this.createStroke(t))}createStroke(t){return[I.SET_STROKE_STYLE,t.strokeStyle,t.lineWidth*this.pixelRatio,t.lineCap,t.lineJoin,t.miterLimit,this.applyPixelRatio(t.lineDash),t.lineDashOffset*this.pixelRatio]}updateFillStyle(t,e){const i=t.fillStyle;(typeof i!="string"||t.currentFillStyle!=i)&&(i!==void 0&&this.instructions.push(e.call(this,t)),t.currentFillStyle=i)}updateStrokeStyle(t,e){const i=t.strokeStyle,n=t.lineCap,o=t.lineDash,s=t.lineDashOffset,r=t.lineJoin,l=t.lineWidth,h=t.miterLimit;(t.currentStrokeStyle!=i||t.currentLineCap!=n||o!=t.currentLineDash&&!Zt(t.currentLineDash,o)||t.currentLineDashOffset!=s||t.currentLineJoin!=r||t.currentLineWidth!=l||t.currentMiterLimit!=h)&&(i!==void 0&&e.call(this,t),t.currentStrokeStyle=i,t.currentLineCap=n,t.currentLineDash=o,t.currentLineDashOffset=s,t.currentLineJoin=r,t.currentLineWidth=l,t.currentMiterLimit=h)}endGeometry(t){this.beginGeometryInstruction1_[2]=this.instructions.length,this.beginGeometryInstruction1_=null,this.beginGeometryInstruction2_[2]=this.hitDetectionInstructions.length,this.beginGeometryInstruction2_=null;const e=[I.END_GEOMETRY,t];this.instructions.push(e),this.hitDetectionInstructions.push(e)}getBufferedMaxExtent(){if(!this.bufferedMaxExtent_&&(this.bufferedMaxExtent_=Qe(this.maxExtent),this.maxLineWidth>0)){const t=this.resolution*(this.maxLineWidth+1)/2;oe(this.bufferedMaxExtent_,t,this.bufferedMaxExtent_)}return this.bufferedMaxExtent_}}class Ri extends wt{constructor(t,e,i,n){super(t,e,i,n),this.hitDetectionImage_=null,this.image_=null,this.imagePixelRatio_=void 0,this.anchorX_=void 0,this.anchorY_=void 0,this.height_=void 0,this.opacity_=void 0,this.originX_=void 0,this.originY_=void 0,this.rotateWithView_=void 0,this.rotation_=void 0,this.scale_=void 0,this.width_=void 0,this.declutterMode_=void 0,this.declutterImageWithText_=void 0}drawPoint(t,e,i){if(!this.image_||this.maxExtent&&!se(this.maxExtent,t.getFlatCoordinates()))return;this.beginGeometry(t,e,i);const n=t.getFlatCoordinates(),o=t.getStride(),s=this.coordinates.length,r=this.appendFlatPointCoordinates(n,o);this.instructions.push([I.DRAW_IMAGE,s,r,this.image_,this.anchorX_*this.imagePixelRatio_,this.anchorY_*this.imagePixelRatio_,Math.ceil(this.height_*this.imagePixelRatio_),this.opacity_,this.originX_*this.imagePixelRatio_,this.originY_*this.imagePixelRatio_,this.rotateWithView_,this.rotation_,[this.scale_[0]*this.pixelRatio/this.imagePixelRatio_,this.scale_[1]*this.pixelRatio/this.imagePixelRatio_],Math.ceil(this.width_*this.imagePixelRatio_),this.declutterMode_,this.declutterImageWithText_]),this.hitDetectionInstructions.push([I.DRAW_IMAGE,s,r,this.hitDetectionImage_,this.anchorX_,this.anchorY_,this.height_,1,this.originX_,this.originY_,this.rotateWithView_,this.rotation_,this.scale_,this.width_,this.declutterMode_,this.declutterImageWithText_]),this.endGeometry(e)}drawMultiPoint(t,e,i){if(!this.image_)return;this.beginGeometry(t,e,i);const n=t.getFlatCoordinates(),o=[];for(let l=0,h=n.length;l<h;l+=t.getStride())(!this.maxExtent||se(this.maxExtent,n.slice(l,l+2)))&&o.push(n[l],n[l+1]);const s=this.coordinates.length,r=this.appendFlatPointCoordinates(o,2);this.instructions.push([I.DRAW_IMAGE,s,r,this.image_,this.anchorX_*this.imagePixelRatio_,this.anchorY_*this.imagePixelRatio_,Math.ceil(this.height_*this.imagePixelRatio_),this.opacity_,this.originX_*this.imagePixelRatio_,this.originY_*this.imagePixelRatio_,this.rotateWithView_,this.rotation_,[this.scale_[0]*this.pixelRatio/this.imagePixelRatio_,this.scale_[1]*this.pixelRatio/this.imagePixelRatio_],Math.ceil(this.width_*this.imagePixelRatio_),this.declutterMode_,this.declutterImageWithText_]),this.hitDetectionInstructions.push([I.DRAW_IMAGE,s,r,this.hitDetectionImage_,this.anchorX_,this.anchorY_,this.height_,1,this.originX_,this.originY_,this.rotateWithView_,this.rotation_,this.scale_,this.width_,this.declutterMode_,this.declutterImageWithText_]),this.endGeometry(e)}finish(){return this.reverseHitDetectionInstructions(),this.anchorX_=void 0,this.anchorY_=void 0,this.hitDetectionImage_=null,this.image_=null,this.imagePixelRatio_=void 0,this.height_=void 0,this.scale_=void 0,this.opacity_=void 0,this.originX_=void 0,this.originY_=void 0,this.rotateWithView_=void 0,this.rotation_=void 0,this.width_=void 0,super.finish()}setImageStyle(t,e){const i=t.getAnchor(),n=t.getSize(),o=t.getOrigin();this.imagePixelRatio_=t.getPixelRatio(this.pixelRatio),this.anchorX_=i[0],this.anchorY_=i[1],this.hitDetectionImage_=t.getHitDetectionImage(),this.image_=t.getImage(this.pixelRatio),this.height_=n[1],this.opacity_=t.getOpacity(),this.originX_=o[0],this.originY_=o[1],this.rotateWithView_=t.getRotateWithView(),this.rotation_=t.getRotation(),this.scale_=t.getScaleArray(),this.width_=n[0],this.declutterMode_=t.getDeclutterMode(),this.declutterImageWithText_=e}}class ki extends wt{constructor(t,e,i,n){super(t,e,i,n)}drawFlatCoordinates_(t,e,i,n){const o=this.coordinates.length,s=this.appendFlatLineCoordinates(t,e,i,n,!1,!1),r=[I.MOVE_TO_LINE_TO,o,s];return this.instructions.push(r),this.hitDetectionInstructions.push(r),i}drawLineString(t,e,i){const n=this.state,o=n.strokeStyle,s=n.lineWidth;if(o===void 0||s===void 0)return;this.updateStrokeStyle(n,this.applyStroke),this.beginGeometry(t,e,i),this.hitDetectionInstructions.push([I.SET_STROKE_STYLE,n.strokeStyle,n.lineWidth,n.lineCap,n.lineJoin,n.miterLimit,nt,st],ut);const r=t.getFlatCoordinates(),l=t.getStride();this.drawFlatCoordinates_(r,0,r.length,l),this.hitDetectionInstructions.push(ht),this.endGeometry(e)}drawMultiLineString(t,e,i){const n=this.state,o=n.strokeStyle,s=n.lineWidth;if(o===void 0||s===void 0)return;this.updateStrokeStyle(n,this.applyStroke),this.beginGeometry(t,e,i),this.hitDetectionInstructions.push([I.SET_STROKE_STYLE,n.strokeStyle,n.lineWidth,n.lineCap,n.lineJoin,n.miterLimit,nt,st],ut);const r=t.getEnds(),l=t.getFlatCoordinates(),h=t.getStride();let a=0;for(let c=0,u=r.length;c<u;++c)a=this.drawFlatCoordinates_(l,a,r[c],h);this.hitDetectionInstructions.push(ht),this.endGeometry(e)}finish(){const t=this.state;return t.lastStroke!=null&&t.lastStroke!=this.coordinates.length&&this.instructions.push(ht),this.reverseHitDetectionInstructions(),this.state=null,super.finish()}applyStroke(t){t.lastStroke!=null&&t.lastStroke!=this.coordinates.length&&(this.instructions.push(ht),t.lastStroke=this.coordinates.length),t.lastStroke=0,super.applyStroke(t),this.instructions.push(ut)}}class Le extends wt{constructor(t,e,i,n){super(t,e,i,n)}drawFlatCoordinatess_(t,e,i,n){const o=this.state,s=o.fillStyle!==void 0,r=o.strokeStyle!==void 0,l=i.length;this.instructions.push(ut),this.hitDetectionInstructions.push(ut);for(let h=0;h<l;++h){const a=i[h],c=this.coordinates.length,u=this.appendFlatLineCoordinates(t,e,a,n,!0,!r),d=[I.MOVE_TO_LINE_TO,c,u];this.instructions.push(d),this.hitDetectionInstructions.push(d),r&&(this.instructions.push(we),this.hitDetectionInstructions.push(we)),e=a}return s&&(this.instructions.push(Mt),this.hitDetectionInstructions.push(Mt)),r&&(this.instructions.push(ht),this.hitDetectionInstructions.push(ht)),e}drawCircle(t,e,i){const n=this.state,o=n.fillStyle,s=n.strokeStyle;if(o===void 0&&s===void 0)return;this.setFillStrokeStyles_(),this.beginGeometry(t,e,i),n.fillStyle!==void 0&&this.hitDetectionInstructions.push([I.SET_FILL_STYLE,H]),n.strokeStyle!==void 0&&this.hitDetectionInstructions.push([I.SET_STROKE_STYLE,n.strokeStyle,n.lineWidth,n.lineCap,n.lineJoin,n.miterLimit,nt,st]);const r=t.getFlatCoordinates(),l=t.getStride(),h=this.coordinates.length;this.appendFlatLineCoordinates(r,0,r.length,l,!1,!1);const a=[I.CIRCLE,h];this.instructions.push(ut,a),this.hitDetectionInstructions.push(ut,a),n.fillStyle!==void 0&&(this.instructions.push(Mt),this.hitDetectionInstructions.push(Mt)),n.strokeStyle!==void 0&&(this.instructions.push(ht),this.hitDetectionInstructions.push(ht)),this.endGeometry(e)}drawPolygon(t,e,i){const n=this.state,o=n.fillStyle,s=n.strokeStyle;if(o===void 0&&s===void 0)return;this.setFillStrokeStyles_(),this.beginGeometry(t,e,i),n.fillStyle!==void 0&&this.hitDetectionInstructions.push([I.SET_FILL_STYLE,H]),n.strokeStyle!==void 0&&this.hitDetectionInstructions.push([I.SET_STROKE_STYLE,n.strokeStyle,n.lineWidth,n.lineCap,n.lineJoin,n.miterLimit,nt,st]);const r=t.getEnds(),l=t.getOrientedFlatCoordinates(),h=t.getStride();this.drawFlatCoordinatess_(l,0,r,h),this.endGeometry(e)}drawMultiPolygon(t,e,i){const n=this.state,o=n.fillStyle,s=n.strokeStyle;if(o===void 0&&s===void 0)return;this.setFillStrokeStyles_(),this.beginGeometry(t,e,i),n.fillStyle!==void 0&&this.hitDetectionInstructions.push([I.SET_FILL_STYLE,H]),n.strokeStyle!==void 0&&this.hitDetectionInstructions.push([I.SET_STROKE_STYLE,n.strokeStyle,n.lineWidth,n.lineCap,n.lineJoin,n.miterLimit,nt,st]);const r=t.getEndss(),l=t.getOrientedFlatCoordinates(),h=t.getStride();let a=0;for(let c=0,u=r.length;c<u;++c)a=this.drawFlatCoordinatess_(l,a,r[c],h);this.endGeometry(e)}finish(){this.reverseHitDetectionInstructions(),this.state=null;const t=this.tolerance;if(t!==0){const e=this.coordinates;for(let i=0,n=e.length;i<n;++i)e[i]=ti(e[i],t)}return super.finish()}setFillStrokeStyles_(){const t=this.state;t.fillStyle!==void 0&&this.updateFillStyle(t,this.createFill),t.strokeStyle!==void 0&&this.updateStrokeStyle(t,this.applyStroke)}}function wi(f,t,e,i,n){const o=[];let s=e,r=0,l=t.slice(e,2);for(;r<f&&s+n<i;){const[h,a]=l.slice(-2),c=t[s+n],u=t[s+n+1],d=Math.sqrt((c-h)*(c-h)+(u-a)*(u-a));if(r+=d,r>=f){const g=(f-r+d)/d,x=U(h,c,g),_=U(a,u,g);l.push(x,_),o.push(l),l=[x,_],r==f&&(s+=n),r=0}else if(r<f)l.push(t[s+n],t[s+n+1]),s+=n;else{const g=d-r,x=U(h,c,g/d),_=U(a,u,g/d);l.push(x,_),o.push(l),l=[x,_],r=0,s+=n}}return r>0&&o.push(l),o}function Li(f,t,e,i,n){let o=e,s=e,r=0,l=0,h=e,a,c,u,d,g,x,_,p,S,y;for(c=e;c<i;c+=n){const C=t[c],T=t[c+1];g!==void 0&&(S=C-g,y=T-x,d=Math.sqrt(S*S+y*y),_!==void 0&&(l+=u,a=Math.acos((_*S+p*y)/(u*d)),a>f&&(l>r&&(r=l,o=h,s=c),l=0,h=c-n)),u=d,_=S,p=y),g=C,x=T}return l+=d,l>r?[h,c]:[o,s]}const Vt={left:0,center:.5,right:1,top:0,middle:.5,hanging:.2,alphabetic:.8,ideographic:.8,bottom:1};class Ei extends wt{constructor(t,e,i,n){super(t,e,i,n),this.labels_=null,this.text_="",this.textOffsetX_=0,this.textOffsetY_=0,this.textRotateWithView_=void 0,this.textRotation_=0,this.textFillState_=null,this.fillStates={},this.fillStates[H]={fillStyle:H},this.textStrokeState_=null,this.strokeStates={},this.textState_={},this.textStates={},this.textKey_="",this.fillKey_="",this.strokeKey_="",this.declutterMode_=void 0,this.declutterImageWithText_=void 0}finish(){const t=super.finish();return t.textStates=this.textStates,t.fillStates=this.fillStates,t.strokeStates=this.strokeStates,t}drawText(t,e,i){const n=this.textFillState_,o=this.textStrokeState_,s=this.textState_;if(this.text_===""||!s||!n&&!o)return;const r=this.coordinates;let l=r.length;const h=t.getType();let a=null,c=t.getStride();if(s.placement==="line"&&(h=="LineString"||h=="MultiLineString"||h=="Polygon"||h=="MultiPolygon")){if(!it(this.maxExtent,t.getExtent()))return;let u;if(a=t.getFlatCoordinates(),h=="LineString")u=[a.length];else if(h=="MultiLineString")u=t.getEnds();else if(h=="Polygon")u=t.getEnds().slice(0,1);else if(h=="MultiPolygon"){const _=t.getEndss();u=[];for(let p=0,S=_.length;p<S;++p)u.push(_[p][0])}this.beginGeometry(t,e,i);const d=s.repeat,g=d?void 0:s.textAlign;let x=0;for(let _=0,p=u.length;_<p;++_){let S;d?S=wi(d*this.resolution,a,x,u[_],c):S=[a.slice(x,u[_])];for(let y=0,C=S.length;y<C;++y){const T=S[y];let L=0,E=T.length;if(g==null){const w=Li(s.maxAngle,T,0,T.length,2);L=w[0],E=w[1]}for(let w=L;w<E;w+=c)r.push(T[w],T[w+1]);const k=r.length;x=u[_],this.drawChars_(l,k),l=k}}this.endGeometry(e)}else{let u=s.overflow?null:[];switch(h){case"Point":case"MultiPoint":a=t.getFlatCoordinates();break;case"LineString":a=t.getFlatMidpoint();break;case"Circle":a=t.getCenter();break;case"MultiLineString":a=t.getFlatMidpoints(),c=2;break;case"Polygon":a=t.getFlatInteriorPoint(),s.overflow||u.push(a[2]/this.resolution),c=3;break;case"MultiPolygon":const S=t.getFlatInteriorPoints();a=[];for(let y=0,C=S.length;y<C;y+=3)s.overflow||u.push(S[y+2]/this.resolution),a.push(S[y],S[y+1]);if(a.length===0)return;c=2;break}const d=this.appendFlatPointCoordinates(a,c);if(d===l)return;if(u&&(d-l)/2!==a.length/c){let S=l/2;u=u.filter((y,C)=>{const T=r[(S+C)*2]===a[C*c]&&r[(S+C)*2+1]===a[C*c+1];return T||--S,T})}this.saveTextStates_(),(s.backgroundFill||s.backgroundStroke)&&(this.setFillStrokeStyle(s.backgroundFill,s.backgroundStroke),s.backgroundFill&&this.updateFillStyle(this.state,this.createFill),s.backgroundStroke&&(this.updateStrokeStyle(this.state,this.applyStroke),this.hitDetectionInstructions.push(this.createStroke(this.state)))),this.beginGeometry(t,e,i);let g=s.padding;if(g!=dt&&(s.scale[0]<0||s.scale[1]<0)){let S=s.padding[0],y=s.padding[1],C=s.padding[2],T=s.padding[3];s.scale[0]<0&&(y=-y,T=-T),s.scale[1]<0&&(S=-S,C=-C),g=[S,y,C,T]}const x=this.pixelRatio;this.instructions.push([I.DRAW_IMAGE,l,d,null,NaN,NaN,NaN,1,0,0,this.textRotateWithView_,this.textRotation_,[1,1],NaN,this.declutterMode_,this.declutterImageWithText_,g==dt?dt:g.map(function(S){return S*x}),!!s.backgroundFill,!!s.backgroundStroke,this.text_,this.textKey_,this.strokeKey_,this.fillKey_,this.textOffsetX_,this.textOffsetY_,u]);const _=1/x,p=this.state.fillStyle;s.backgroundFill&&(this.state.fillStyle=H,this.hitDetectionInstructions.push(this.createFill(this.state))),this.hitDetectionInstructions.push([I.DRAW_IMAGE,l,d,null,NaN,NaN,NaN,1,0,0,this.textRotateWithView_,this.textRotation_,[_,_],NaN,this.declutterMode_,this.declutterImageWithText_,g,!!s.backgroundFill,!!s.backgroundStroke,this.text_,this.textKey_,this.strokeKey_,this.fillKey_?H:this.fillKey_,this.textOffsetX_,this.textOffsetY_,u]),s.backgroundFill&&(this.state.fillStyle=p,this.hitDetectionInstructions.push(this.createFill(this.state))),this.endGeometry(e)}}saveTextStates_(){const t=this.textStrokeState_,e=this.textState_,i=this.textFillState_,n=this.strokeKey_;t&&(n in this.strokeStates||(this.strokeStates[n]={strokeStyle:t.strokeStyle,lineCap:t.lineCap,lineDashOffset:t.lineDashOffset,lineWidth:t.lineWidth,lineJoin:t.lineJoin,miterLimit:t.miterLimit,lineDash:t.lineDash}));const o=this.textKey_;o in this.textStates||(this.textStates[o]={font:e.font,textAlign:e.textAlign||Rt,justify:e.justify,textBaseline:e.textBaseline||Yt,scale:e.scale});const s=this.fillKey_;i&&(s in this.fillStates||(this.fillStates[s]={fillStyle:i.fillStyle}))}drawChars_(t,e){const i=this.textStrokeState_,n=this.textState_,o=this.strokeKey_,s=this.textKey_,r=this.fillKey_;this.saveTextStates_();const l=this.pixelRatio,h=Vt[n.textBaseline],a=this.textOffsetY_*l,c=this.text_,u=i?i.lineWidth*Math.abs(n.scale[0])/2:0;this.instructions.push([I.DRAW_CHARS,t,e,h,n.overflow,r,n.maxAngle,l,a,o,u*l,c,s,1,this.declutterMode_]),this.hitDetectionInstructions.push([I.DRAW_CHARS,t,e,h,n.overflow,r&&H,n.maxAngle,l,a,o,u*l,c,s,1/l,this.declutterMode_])}setTextStyle(t,e){let i,n,o;if(!t)this.text_="";else{const s=t.getFill();s?(n=this.textFillState_,n||(n={},this.textFillState_=n),n.fillStyle=at(s.getColor()||H)):(n=null,this.textFillState_=n);const r=t.getStroke();if(!r)o=null,this.textStrokeState_=o;else{o=this.textStrokeState_,o||(o={},this.textStrokeState_=o);const g=r.getLineDash(),x=r.getLineDashOffset(),_=r.getWidth(),p=r.getMiterLimit();o.lineCap=r.getLineCap()||Pt,o.lineDash=g?g.slice():nt,o.lineDashOffset=x===void 0?st:x,o.lineJoin=r.getLineJoin()||vt,o.lineWidth=_===void 0?Gt:_,o.miterLimit=p===void 0?Bt:p,o.strokeStyle=at(r.getColor()||At)}i=this.textState_;const l=t.getFont()||be;ei(l);const h=t.getScaleArray();i.overflow=t.getOverflow(),i.font=l,i.maxAngle=t.getMaxAngle(),i.placement=t.getPlacement(),i.textAlign=t.getTextAlign(),i.repeat=t.getRepeat(),i.justify=t.getJustify(),i.textBaseline=t.getTextBaseline()||Yt,i.backgroundFill=t.getBackgroundFill(),i.backgroundStroke=t.getBackgroundStroke(),i.padding=t.getPadding()||dt,i.scale=h===void 0?[1,1]:h;const a=t.getOffsetX(),c=t.getOffsetY(),u=t.getRotateWithView(),d=t.getRotation();this.text_=t.getText()||"",this.textOffsetX_=a===void 0?0:a,this.textOffsetY_=c===void 0?0:c,this.textRotateWithView_=u===void 0?!1:u,this.textRotation_=d===void 0?0:d,this.strokeKey_=o?(typeof o.strokeStyle=="string"?o.strokeStyle:kt(o.strokeStyle))+o.lineCap+o.lineDashOffset+"|"+o.lineWidth+o.lineJoin+o.miterLimit+"["+o.lineDash.join()+"]":"",this.textKey_=i.font+i.scale+(i.textAlign||"?")+(i.repeat||"?")+(i.justify||"?")+(i.textBaseline||"?"),this.fillKey_=n&&n.fillStyle?typeof n.fillStyle=="string"?n.fillStyle:"|"+kt(n.fillStyle):""}this.declutterMode_=t.getDeclutterMode(),this.declutterImageWithText_=e}}const Di={Circle:Le,Default:wt,Image:Ri,LineString:ki,Polygon:Le,Text:Ei};class Oi{constructor(t,e,i,n){this.tolerance_=t,this.maxExtent_=e,this.pixelRatio_=n,this.resolution_=i,this.buildersByZIndex_={}}finish(){const t={};for(const e in this.buildersByZIndex_){t[e]=t[e]||{};const i=this.buildersByZIndex_[e];for(const n in i){const o=i[n].finish();t[e][n]=o}}return t}getBuilder(t,e){const i=t!==void 0?t.toString():"0";let n=this.buildersByZIndex_[i];n===void 0&&(n={},this.buildersByZIndex_[i]=n);let o=n[e];if(o===void 0){const s=Di[e];o=new s(this.tolerance_,this.maxExtent_,this.resolution_,this.pixelRatio_),n[e]=o}return o}}function Fi(f,t,e,i,n,o,s,r,l,h,a,c){let u=f[t],d=f[t+1],g=0,x=0,_=0,p=0;function S(){g=u,x=d,t+=i,u=f[t],d=f[t+1],p+=_,_=Math.sqrt((u-g)*(u-g)+(d-x)*(d-x))}do S();while(t<e-i&&p+_<o);let y=_===0?0:(o-p)/_;const C=U(g,u,y),T=U(x,d,y),L=t-i,E=p,k=o+r*l(h,n,a);for(;t<e-i&&p+_<k;)S();y=_===0?0:(k-p)/_;const w=U(g,u,y),P=U(x,d,y);let F;if(c){const R=[C,T,w,P];ii(R,0,4,2,c,R,R),F=R[0]>R[2]}else F=C>w;const D=Math.PI,W=[],O=L+i===t;t=L,_=0,p=E,u=f[t],d=f[t+1];let b;if(O){S(),b=Math.atan2(d-x,u-g),F&&(b+=b>0?-D:D);const R=(w+C)/2,v=(P+T)/2;return W[0]=[R,v,(k-o)/2,b,n],W}n=n.replace(/\n/g," ");for(let R=0,v=n.length;R<v;){S();let A=Math.atan2(d-x,u-g);if(F&&(A+=A>0?-D:D),b!==void 0){let m=A-b;if(m+=m>D?-2*D:m<-D?2*D:0,Math.abs(m)>s)return null}b=A;const X=R;let M=0;for(;R<v;++R){const m=F?v-R-1:R,Ht=r*l(h,n[m],a);if(t+i<e&&p+_<o+M+Ht/2)break;M+=Ht}if(R===X)continue;const B=F?n.substring(v-X,v-R):n.substring(X,R);y=_===0?0:(o+M/2-p)/_;const N=U(g,u,y),ot=U(x,d,y);W.push([N,ot,M/2,A,B]),o+=M}return W}const ft=Nt(),rt=[],tt=[],et=[],lt=[];function Ee(f){return f[3].declutterBox}const De=new RegExp("[֑-ࣿיִ-﷿ﹰ-ﻼࠀ-࿿-]");function ie(f,t){return t==="start"?t=De.test(f)?"right":"left":t==="end"&&(t=De.test(f)?"left":"right"),Vt[t]}function bi(f,t,e){return e>0&&f.push(`
`,""),f.push(t,""),f}class Mi{constructor(t,e,i,n,o){this.overlaps=i,this.pixelRatio=e,this.resolution=t,this.alignAndScaleFill_,this.instructions=n.instructions,this.coordinates=n.coordinates,this.coordinateCache_={},this.renderedTransform_=Xt(),this.hitDetectionInstructions=n.hitDetectionInstructions,this.pixelCoordinates_=null,this.viewRotation_=0,this.fillStates=n.fillStates||{},this.strokeStates=n.strokeStates||{},this.textStates=n.textStates||{},this.widths_={},this.labels_={},this.zIndexContext_=o?new ni:null}getZIndexContext(){return this.zIndexContext_}createLabel(t,e,i,n){const o=t+e+i+n;if(this.labels_[o])return this.labels_[o];const s=n?this.strokeStates[n]:null,r=i?this.fillStates[i]:null,l=this.textStates[e],h=this.pixelRatio,a=[l.scale[0]*h,l.scale[1]*h],c=l.justify?Vt[l.justify]:ie(Array.isArray(t)?t[0]:t,l.textAlign||Rt),u=n&&s.lineWidth?s.lineWidth:0,d=Array.isArray(t)?t:String(t).split(`
`).reduce(bi,[]),{width:g,height:x,widths:_,heights:p,lineWidths:S}=si(l,d),y=g+u,C=[],T=(y+2)*a[0],L=(x+u)*a[1],E={width:T<0?Math.floor(T):Math.ceil(T),height:L<0?Math.floor(L):Math.ceil(L),contextInstructions:C};(a[0]!=1||a[1]!=1)&&C.push("scale",a),n&&(C.push("strokeStyle",s.strokeStyle),C.push("lineWidth",u),C.push("lineCap",s.lineCap),C.push("lineJoin",s.lineJoin),C.push("miterLimit",s.miterLimit),C.push("setLineDash",[s.lineDash]),C.push("lineDashOffset",s.lineDashOffset)),i&&C.push("fillStyle",r.fillStyle),C.push("textBaseline","middle"),C.push("textAlign","center");const k=.5-c;let w=c*y+k*u;const P=[],F=[];let D=0,W=0,O=0,b=0,R;for(let v=0,A=d.length;v<A;v+=2){const X=d[v];if(X===`
`){W+=D,D=0,w=c*y+k*u,++b;continue}const M=d[v+1]||l.font;M!==R&&(n&&P.push("font",M),i&&F.push("font",M),R=M),D=Math.max(D,p[O]);const B=[X,w+k*_[O]+c*(_[O]-S[b]),.5*(u+D)+W];w+=_[O],n&&P.push("strokeText",B),i&&F.push("fillText",B),++O}return Array.prototype.push.apply(C,P),Array.prototype.push.apply(C,F),this.labels_[o]=E,E}replayTextBackground_(t,e,i,n,o,s,r){t.beginPath(),t.moveTo.apply(t,e),t.lineTo.apply(t,i),t.lineTo.apply(t,n),t.lineTo.apply(t,o),t.lineTo.apply(t,e),s&&(this.alignAndScaleFill_=s[2],this.fill_(t)),r&&(this.setStrokeStyle_(t,r),t.stroke())}calculateImageOrLabelDimensions_(t,e,i,n,o,s,r,l,h,a,c,u,d,g,x,_){r*=u[0],l*=u[1];let p=i-r,S=n-l;const y=o+h>t?t-h:o,C=s+a>e?e-a:s,T=g[3]+y*u[0]+g[1],L=g[0]+C*u[1]+g[2],E=p-g[3],k=S-g[0];(x||c!==0)&&(rt[0]=E,lt[0]=E,rt[1]=k,tt[1]=k,tt[0]=E+T,et[0]=tt[0],et[1]=k+L,lt[1]=et[1]);let w;return c!==0?(w=re(Xt(),i,n,1,1,c,-i,-n),yt(w,rt),yt(w,tt),yt(w,et),yt(w,lt),Ce(Math.min(rt[0],tt[0],et[0],lt[0]),Math.min(rt[1],tt[1],et[1],lt[1]),Math.max(rt[0],tt[0],et[0],lt[0]),Math.max(rt[1],tt[1],et[1],lt[1]),ft)):Ce(Math.min(E,E+T),Math.min(k,k+L),Math.max(E,E+T),Math.max(k,k+L),ft),d&&(p=Math.round(p),S=Math.round(S)),{drawImageX:p,drawImageY:S,drawImageW:y,drawImageH:C,originX:h,originY:a,declutterBox:{minX:ft[0],minY:ft[1],maxX:ft[2],maxY:ft[3],value:_},canvasTransform:w,scale:u}}replayImageOrLabel_(t,e,i,n,o,s,r){const l=!!(s||r),h=n.declutterBox,a=r?r[2]*n.scale[0]/2:0;return h.minX-a<=e[0]&&h.maxX+a>=0&&h.minY-a<=e[1]&&h.maxY+a>=0&&(l&&this.replayTextBackground_(t,rt,tt,et,lt,s,r),oi(t,n.canvasTransform,o,i,n.originX,n.originY,n.drawImageW,n.drawImageH,n.drawImageX,n.drawImageY,n.scale)),!0}fill_(t){const e=this.alignAndScaleFill_;if(e){const i=yt(this.renderedTransform_,[0,0]),n=512*this.pixelRatio;t.save(),t.translate(i[0]%n,i[1]%n),e!==1&&t.scale(e,e),t.rotate(this.viewRotation_)}t.fill(),e&&t.restore()}setStrokeStyle_(t,e){t.strokeStyle=e[1],t.lineWidth=e[2],t.lineCap=e[3],t.lineJoin=e[4],t.miterLimit=e[5],t.lineDashOffset=e[7],t.setLineDash(e[6])}drawLabelWithPointPlacement_(t,e,i,n){const o=this.textStates[e],s=this.createLabel(t,e,n,i),r=this.strokeStates[i],l=this.pixelRatio,h=ie(Array.isArray(t)?t[0]:t,o.textAlign||Rt),a=Vt[o.textBaseline||Yt],c=r&&r.lineWidth?r.lineWidth:0,u=s.width/l-2*o.scale[0],d=h*u+2*(.5-h)*c,g=a*s.height/l+2*(.5-a)*c;return{label:s,anchorX:d,anchorY:g}}execute_(t,e,i,n,o,s,r,l){const h=this.zIndexContext_;let a;this.pixelCoordinates_&&Zt(i,this.renderedTransform_)?a=this.pixelCoordinates_:(this.pixelCoordinates_||(this.pixelCoordinates_=[]),a=It(this.coordinates,0,this.coordinates.length,2,i,this.pixelCoordinates_),ri(this.renderedTransform_,i));let c=0;const u=n.length;let d=0,g,x,_,p,S,y,C,T,L,E,k,w,P,F=0,D=0,W=null,O=null;const b=this.coordinateCache_,R=this.viewRotation_,v=Math.round(Math.atan2(-i[1],i[0])*1e12)/1e12,A={context:t,pixelRatio:this.pixelRatio,resolution:this.resolution,rotation:R},X=this.instructions!=n||this.overlaps?0:200;let M,B,N,ot;for(;c<u;){const m=n[c];switch(m[0]){case I.BEGIN_GEOMETRY:M=m[1],ot=m[3],M.getGeometry()?r!==void 0&&!it(r,ot.getExtent())?c=m[2]+1:++c:c=m[2],h&&(h.zIndex=m[4]);break;case I.BEGIN_PATH:F>X&&(this.fill_(t),F=0),D>X&&(t.stroke(),D=0),!F&&!D&&(t.beginPath(),S=NaN,y=NaN),++c;break;case I.CIRCLE:d=m[1];const Jt=a[d],Kt=a[d+1],Ge=a[d+2],Be=a[d+3],le=Ge-Jt,ae=Be-Kt,he=Math.sqrt(le*le+ae*ae);t.moveTo(Jt+he,Kt),t.arc(Jt,Kt,he,0,2*Math.PI,!0),++c;break;case I.CLOSE_PATH:t.closePath(),++c;break;case I.CUSTOM:d=m[1],g=m[2];const Ye=m[3],Xe=m[4],ce=m[5];A.geometry=Ye,A.feature=M,c in b||(b[c]=[]);const _t=b[c];ce?ce(a,d,g,2,_t):(_t[0]=a[d],_t[1]=a[d+1],_t.length=2),h&&(h.zIndex=m[6]),Xe(_t,A),++c;break;case I.DRAW_IMAGE:d=m[1],g=m[2],L=m[3],x=m[4],_=m[5];let Ut=m[6];const Ne=m[7],je=m[8],Ve=m[9],de=m[10];let qt=m[11];const Ze=m[12];let Lt=m[13];p=m[14]||"declutter";const xt=m[15];if(!L&&m.length>=20){E=m[19],k=m[20],w=m[21],P=m[22];const j=this.drawLabelWithPointPlacement_(E,k,w,P);L=j.label,m[3]=L;const ct=m[23];x=(j.anchorX-ct)*this.pixelRatio,m[4]=x;const V=m[24];_=(j.anchorY-V)*this.pixelRatio,m[5]=_,Ut=L.height,m[6]=Ut,Lt=L.width,m[13]=Lt}let zt;m.length>25&&(zt=m[25]);let $t,Et,Dt;m.length>17?($t=m[16],Et=m[17],Dt=m[18]):($t=dt,Et=!1,Dt=!1),de&&v?qt+=R:!de&&!v&&(qt-=R);let He=0;for(;d<g;d+=2){if(zt&&zt[He++]<Lt/this.pixelRatio)continue;const j=this.calculateImageOrLabelDimensions_(L.width,L.height,a[d],a[d+1],Lt,Ut,x,_,je,Ve,qt,Ze,o,$t,Et||Dt,M),ct=[t,e,L,j,Ne,Et?W:null,Dt?O:null];if(l){let V,K,Z;if(xt){const G=g-d;if(!xt[G]){xt[G]={args:ct,declutterMode:p};continue}const Y=xt[G];V=Y.args,K=Y.declutterMode,delete xt[G],Z=Ee(V)}let z,$;if(V&&(K!=="declutter"||!l.collides(Z))&&(z=!0),(p!=="declutter"||!l.collides(j.declutterBox))&&($=!0),K==="declutter"&&p==="declutter"){const G=z&&$;z=G,$=G}z&&(K!=="none"&&l.insert(Z),this.replayImageOrLabel_.apply(this,V)),$&&(p!=="none"&&l.insert(j.declutterBox),this.replayImageOrLabel_.apply(this,ct))}else this.replayImageOrLabel_.apply(this,ct)}++c;break;case I.DRAW_CHARS:const ue=m[1],fe=m[2],Qt=m[3],Je=m[4];P=m[5];const Ke=m[6],ge=m[7],_e=m[8];w=m[9];const te=m[10];E=m[11],k=m[12];const xe=[m[13],m[13]];p=m[14]||"declutter";const ee=this.textStates[k],pt=ee.font,St=[ee.scale[0]*ge,ee.scale[1]*ge];let mt;pt in this.widths_?mt=this.widths_[pt]:(mt={},this.widths_[pt]=mt);const pe=li(a,ue,fe,2),Se=Math.abs(St[0])*Ie(pt,E,mt);if(Je||Se<=pe){const j=this.textStates[k].textAlign,ct=(pe-Se)*ie(E,j),V=Fi(a,ue,fe,2,E,ct,Ke,Math.abs(St[0]),Ie,pt,mt,v?0:this.viewRotation_);t:if(V){const K=[];let Z,z,$,G,Y;if(w)for(Z=0,z=V.length;Z<z;++Z){Y=V[Z],$=Y[4],G=this.createLabel($,k,"",w),x=Y[2]+(St[0]<0?-te:te),_=Qt*G.height+(.5-Qt)*2*te*St[1]/St[0]-_e;const Q=this.calculateImageOrLabelDimensions_(G.width,G.height,Y[0],Y[1],G.width,G.height,x,_,0,0,Y[3],xe,!1,dt,!1,M);if(l&&p==="declutter"&&l.collides(Q.declutterBox))break t;K.push([t,e,G,Q,1,null,null])}if(P)for(Z=0,z=V.length;Z<z;++Z){Y=V[Z],$=Y[4],G=this.createLabel($,k,P,""),x=Y[2],_=Qt*G.height-_e;const Q=this.calculateImageOrLabelDimensions_(G.width,G.height,Y[0],Y[1],G.width,G.height,x,_,0,0,Y[3],xe,!1,dt,!1,M);if(l&&p==="declutter"&&l.collides(Q.declutterBox))break t;K.push([t,e,G,Q,1,null,null])}l&&p!=="none"&&l.load(K.map(Ee));for(let Q=0,Ue=K.length;Q<Ue;++Q)this.replayImageOrLabel_.apply(this,K[Q])}}++c;break;case I.END_GEOMETRY:if(s!==void 0){M=m[1];const j=s(M,ot,p);if(j)return j}++c;break;case I.FILL:X?F++:this.fill_(t),++c;break;case I.MOVE_TO_LINE_TO:for(d=m[1],g=m[2],B=a[d],N=a[d+1],t.moveTo(B,N),S=B+.5|0,y=N+.5|0,d+=2;d<g;d+=2)B=a[d],N=a[d+1],C=B+.5|0,T=N+.5|0,(d==g-2||C!==S||T!==y)&&(t.lineTo(B,N),S=C,y=T);++c;break;case I.SET_FILL_STYLE:W=m,this.alignAndScaleFill_=m[2],F&&(this.fill_(t),F=0,D&&(t.stroke(),D=0)),t.fillStyle=m[1],++c;break;case I.SET_STROKE_STYLE:O=m,D&&(t.stroke(),D=0),this.setStrokeStyle_(t,m),++c;break;case I.STROKE:X?D++:t.stroke(),++c;break;default:++c;break}}F&&this.fill_(t),D&&t.stroke()}execute(t,e,i,n,o,s){this.viewRotation_=n,this.execute_(t,e,i,this.instructions,o,void 0,void 0,s)}executeHitDetection(t,e,i,n,o){return this.viewRotation_=i,this.execute_(t,[t.canvas.width,t.canvas.height],e,this.hitDetectionInstructions,!0,n,o)}}const gt=["Polygon","Circle","LineString","Image","Text","Default"],We=["Image","Text"],Wi=gt.filter(f=>!We.includes(f));class Ai{constructor(t,e,i,n,o,s,r){this.maxExtent_=t,this.overlaps_=n,this.pixelRatio_=i,this.resolution_=e,this.renderBuffer_=s,this.executorsByZIndex_={},this.hitDetectionContext_=null,this.hitDetectionTransform_=Xt(),this.renderedContext_=null,this.deferredZIndexContexts_={},this.createExecutors_(o,r)}clip(t,e){const i=this.getClipCoords(e);t.beginPath(),t.moveTo(i[0],i[1]),t.lineTo(i[2],i[3]),t.lineTo(i[4],i[5]),t.lineTo(i[6],i[7]),t.clip()}createExecutors_(t,e){for(const i in t){let n=this.executorsByZIndex_[i];n===void 0&&(n={},this.executorsByZIndex_[i]=n);const o=t[i];for(const s in o){const r=o[s];n[s]=new Mi(this.resolution_,this.pixelRatio_,this.overlaps_,r,e)}}}hasExecutors(t){for(const e in this.executorsByZIndex_){const i=this.executorsByZIndex_[e];for(let n=0,o=t.length;n<o;++n)if(t[n]in i)return!0}return!1}forEachFeatureAtCoordinate(t,e,i,n,o,s){n=Math.round(n);const r=n*2+1,l=re(this.hitDetectionTransform_,n+.5,n+.5,1/e,-1/e,-i,-t[0],-t[1]),h=!this.hitDetectionContext_;h&&(this.hitDetectionContext_=jt(r,r,void 0,{willReadFrequently:!0}));const a=this.hitDetectionContext_;a.canvas.width!==r||a.canvas.height!==r?(a.canvas.width=r,a.canvas.height=r):h||a.clearRect(0,0,r,r);let c;this.renderBuffer_!==void 0&&(c=Nt(),ai(c,t),oe(c,e*(this.renderBuffer_+n),c));const u=Pi(n);let d;function g(T,L,E){const k=a.getImageData(0,0,r,r).data;for(let w=0,P=u.length;w<P;w++)if(k[u[w]]>0){if(!s||E==="none"||d!=="Image"&&d!=="Text"||s.includes(T)){const F=(u[w]-3)/4,D=n-F%r,W=n-(F/r|0),O=o(T,L,D*D+W*W);if(O)return O}a.clearRect(0,0,r,r);break}}const x=Object.keys(this.executorsByZIndex_).map(Number);x.sort(Wt);let _,p,S,y,C;for(_=x.length-1;_>=0;--_){const T=x[_].toString();for(S=this.executorsByZIndex_[T],p=gt.length-1;p>=0;--p)if(d=gt[p],y=S[d],y!==void 0&&(C=y.executeHitDetection(a,l,i,g,c),C))return C}}getClipCoords(t){const e=this.maxExtent_;if(!e)return null;const i=e[0],n=e[1],o=e[2],s=e[3],r=[i,n,i,s,o,s,o,n];return It(r,0,8,2,t,r),r}isEmpty(){return hi(this.executorsByZIndex_)}execute(t,e,i,n,o,s,r){const l=Object.keys(this.executorsByZIndex_).map(Number);l.sort(Wt),s=s||gt;const h=gt.length;let a,c,u,d,g;for(r&&l.reverse(),a=0,c=l.length;a<c;++a){const x=l[a].toString();for(g=this.executorsByZIndex_[x],u=0,d=s.length;u<d;++u){const _=s[u],p=g[_];if(p!==void 0){const S=r===null?void 0:p.getZIndexContext(),y=S?S.getContext():t,C=this.maxExtent_&&_!=="Image"&&_!=="Text";if(C&&(y.save(),this.clip(y,i)),!S||_==="Text"||_==="Image"?p.execute(y,e,i,n,o,r):S.pushFunction(T=>p.execute(T,e,i,n,o,r)),C&&y.restore(),S){S.offset();const T=l[a]*h+u;this.deferredZIndexContexts_[T]||(this.deferredZIndexContexts_[T]=[]),this.deferredZIndexContexts_[T].push(S)}}}}this.renderedContext_=t}getDeferredZIndexContexts(){return this.deferredZIndexContexts_}getRenderedContext(){return this.renderedContext_}renderDeferred(){const t=this.deferredZIndexContexts_,e=Object.keys(t).map(Number).sort(Wt);for(let i=0,n=e.length;i<n;++i)t[e[i]].forEach(o=>{o.draw(this.renderedContext_),o.clear()}),t[e[i]].length=0}}const ne={};function Pi(f){if(ne[f]!==void 0)return ne[f];const t=f*2+1,e=f*f,i=new Array(e+1);for(let o=0;o<=f;++o)for(let s=0;s<=f;++s){const r=o*o+s*s;if(r>e)break;let l=i[r];l||(l=[],i[r]=l),l.push(((f+o)*t+(f+s))*4+3),o>0&&l.push(((f-o)*t+(f+s))*4+3),s>0&&(l.push(((f+o)*t+(f-s))*4+3),o>0&&l.push(((f-o)*t+(f-s))*4+3))}const n=[];for(let o=0,s=i.length;o<s;++o)i[o]&&n.push(...i[o]);return ne[f]=n,n}class vi extends Me{constructor(t,e,i,n,o,s,r){super(),this.context_=t,this.pixelRatio_=e,this.extent_=i,this.transform_=n,this.transformRotation_=n?ci(Math.atan2(n[1],n[0]),10):0,this.viewRotation_=o,this.squaredTolerance_=s,this.userTransform_=r,this.contextFillState_=null,this.contextStrokeState_=null,this.contextTextState_=null,this.fillState_=null,this.strokeState_=null,this.image_=null,this.imageAnchorX_=0,this.imageAnchorY_=0,this.imageHeight_=0,this.imageOpacity_=0,this.imageOriginX_=0,this.imageOriginY_=0,this.imageRotateWithView_=!1,this.imageRotation_=0,this.imageScale_=[0,0],this.imageWidth_=0,this.text_="",this.textOffsetX_=0,this.textOffsetY_=0,this.textRotateWithView_=!1,this.textRotation_=0,this.textScale_=[0,0],this.textFillState_=null,this.textStrokeState_=null,this.textState_=null,this.pixelCoordinates_=[],this.tmpLocalTransform_=Xt()}drawImages_(t,e,i,n){if(!this.image_)return;const o=It(t,e,i,n,this.transform_,this.pixelCoordinates_),s=this.context_,r=this.tmpLocalTransform_,l=s.globalAlpha;this.imageOpacity_!=1&&(s.globalAlpha=l*this.imageOpacity_);let h=this.imageRotation_;this.transformRotation_===0&&(h-=this.viewRotation_),this.imageRotateWithView_&&(h+=this.viewRotation_);for(let a=0,c=o.length;a<c;a+=2){const u=o[a]-this.imageAnchorX_,d=o[a+1]-this.imageAnchorY_;if(h!==0||this.imageScale_[0]!=1||this.imageScale_[1]!=1){const g=u+this.imageAnchorX_,x=d+this.imageAnchorY_;re(r,g,x,1,1,h,-g,-x),s.save(),s.transform.apply(s,r),s.translate(g,x),s.scale(this.imageScale_[0],this.imageScale_[1]),s.drawImage(this.image_,this.imageOriginX_,this.imageOriginY_,this.imageWidth_,this.imageHeight_,-this.imageAnchorX_,-this.imageAnchorY_,this.imageWidth_,this.imageHeight_),s.restore()}else s.drawImage(this.image_,this.imageOriginX_,this.imageOriginY_,this.imageWidth_,this.imageHeight_,u,d,this.imageWidth_,this.imageHeight_)}this.imageOpacity_!=1&&(s.globalAlpha=l)}drawText_(t,e,i,n){if(!this.textState_||this.text_==="")return;this.textFillState_&&this.setContextFillState_(this.textFillState_),this.textStrokeState_&&this.setContextStrokeState_(this.textStrokeState_),this.setContextTextState_(this.textState_);const o=It(t,e,i,n,this.transform_,this.pixelCoordinates_),s=this.context_;let r=this.textRotation_;for(this.transformRotation_===0&&(r-=this.viewRotation_),this.textRotateWithView_&&(r+=this.viewRotation_);e<i;e+=n){const l=o[e]+this.textOffsetX_,h=o[e+1]+this.textOffsetY_;r!==0||this.textScale_[0]!=1||this.textScale_[1]!=1?(s.save(),s.translate(l-this.textOffsetX_,h-this.textOffsetY_),s.rotate(r),s.translate(this.textOffsetX_,this.textOffsetY_),s.scale(this.textScale_[0],this.textScale_[1]),this.textStrokeState_&&s.strokeText(this.text_,0,0),this.textFillState_&&s.fillText(this.text_,0,0),s.restore()):(this.textStrokeState_&&s.strokeText(this.text_,l,h),this.textFillState_&&s.fillText(this.text_,l,h))}}moveToLineTo_(t,e,i,n,o){const s=this.context_,r=It(t,e,i,n,this.transform_,this.pixelCoordinates_);s.moveTo(r[0],r[1]);let l=r.length;o&&(l-=2);for(let h=2;h<l;h+=2)s.lineTo(r[h],r[h+1]);return o&&s.closePath(),i}drawRings_(t,e,i,n){for(let o=0,s=i.length;o<s;++o)e=this.moveToLineTo_(t,e,i[o],n,!0);return e}drawCircle(t){if(this.squaredTolerance_&&(t=t.simplifyTransformed(this.squaredTolerance_,this.userTransform_)),!!it(this.extent_,t.getExtent())){if(this.fillState_||this.strokeState_){this.fillState_&&this.setContextFillState_(this.fillState_),this.strokeState_&&this.setContextStrokeState_(this.strokeState_);const e=di(t,this.transform_,this.pixelCoordinates_),i=e[2]-e[0],n=e[3]-e[1],o=Math.sqrt(i*i+n*n),s=this.context_;s.beginPath(),s.arc(e[0],e[1],o,0,2*Math.PI),this.fillState_&&s.fill(),this.strokeState_&&s.stroke()}this.text_!==""&&this.drawText_(t.getCenter(),0,2,2)}}setStyle(t){this.setFillStrokeStyle(t.getFill(),t.getStroke()),this.setImageStyle(t.getImage()),this.setTextStyle(t.getText())}setTransform(t){this.transform_=t}drawGeometry(t){switch(t.getType()){case"Point":this.drawPoint(t);break;case"LineString":this.drawLineString(t);break;case"Polygon":this.drawPolygon(t);break;case"MultiPoint":this.drawMultiPoint(t);break;case"MultiLineString":this.drawMultiLineString(t);break;case"MultiPolygon":this.drawMultiPolygon(t);break;case"GeometryCollection":this.drawGeometryCollection(t);break;case"Circle":this.drawCircle(t);break}}drawFeature(t,e){const i=e.getGeometryFunction()(t);i&&(this.setStyle(e),this.drawGeometry(i))}drawGeometryCollection(t){const e=t.getGeometriesArray();for(let i=0,n=e.length;i<n;++i)this.drawGeometry(e[i])}drawPoint(t){this.squaredTolerance_&&(t=t.simplifyTransformed(this.squaredTolerance_,this.userTransform_));const e=t.getFlatCoordinates(),i=t.getStride();this.image_&&this.drawImages_(e,0,e.length,i),this.text_!==""&&this.drawText_(e,0,e.length,i)}drawMultiPoint(t){this.squaredTolerance_&&(t=t.simplifyTransformed(this.squaredTolerance_,this.userTransform_));const e=t.getFlatCoordinates(),i=t.getStride();this.image_&&this.drawImages_(e,0,e.length,i),this.text_!==""&&this.drawText_(e,0,e.length,i)}drawLineString(t){if(this.squaredTolerance_&&(t=t.simplifyTransformed(this.squaredTolerance_,this.userTransform_)),!!it(this.extent_,t.getExtent())){if(this.strokeState_){this.setContextStrokeState_(this.strokeState_);const e=this.context_,i=t.getFlatCoordinates();e.beginPath(),this.moveToLineTo_(i,0,i.length,t.getStride(),!1),e.stroke()}if(this.text_!==""){const e=t.getFlatMidpoint();this.drawText_(e,0,2,2)}}}drawMultiLineString(t){this.squaredTolerance_&&(t=t.simplifyTransformed(this.squaredTolerance_,this.userTransform_));const e=t.getExtent();if(it(this.extent_,e)){if(this.strokeState_){this.setContextStrokeState_(this.strokeState_);const i=this.context_,n=t.getFlatCoordinates();let o=0;const s=t.getEnds(),r=t.getStride();i.beginPath();for(let l=0,h=s.length;l<h;++l)o=this.moveToLineTo_(n,o,s[l],r,!1);i.stroke()}if(this.text_!==""){const i=t.getFlatMidpoints();this.drawText_(i,0,i.length,2)}}}drawPolygon(t){if(this.squaredTolerance_&&(t=t.simplifyTransformed(this.squaredTolerance_,this.userTransform_)),!!it(this.extent_,t.getExtent())){if(this.strokeState_||this.fillState_){this.fillState_&&this.setContextFillState_(this.fillState_),this.strokeState_&&this.setContextStrokeState_(this.strokeState_);const e=this.context_;e.beginPath(),this.drawRings_(t.getOrientedFlatCoordinates(),0,t.getEnds(),t.getStride()),this.fillState_&&e.fill(),this.strokeState_&&e.stroke()}if(this.text_!==""){const e=t.getFlatInteriorPoint();this.drawText_(e,0,2,2)}}}drawMultiPolygon(t){if(this.squaredTolerance_&&(t=t.simplifyTransformed(this.squaredTolerance_,this.userTransform_)),!!it(this.extent_,t.getExtent())){if(this.strokeState_||this.fillState_){this.fillState_&&this.setContextFillState_(this.fillState_),this.strokeState_&&this.setContextStrokeState_(this.strokeState_);const e=this.context_,i=t.getOrientedFlatCoordinates();let n=0;const o=t.getEndss(),s=t.getStride();e.beginPath();for(let r=0,l=o.length;r<l;++r){const h=o[r];n=this.drawRings_(i,n,h,s)}this.fillState_&&e.fill(),this.strokeState_&&e.stroke()}if(this.text_!==""){const e=t.getFlatInteriorPoints();this.drawText_(e,0,e.length,2)}}}setContextFillState_(t){const e=this.context_,i=this.contextFillState_;i?i.fillStyle!=t.fillStyle&&(i.fillStyle=t.fillStyle,e.fillStyle=t.fillStyle):(e.fillStyle=t.fillStyle,this.contextFillState_={fillStyle:t.fillStyle})}setContextStrokeState_(t){const e=this.context_,i=this.contextStrokeState_;i?(i.lineCap!=t.lineCap&&(i.lineCap=t.lineCap,e.lineCap=t.lineCap),Zt(i.lineDash,t.lineDash)||e.setLineDash(i.lineDash=t.lineDash),i.lineDashOffset!=t.lineDashOffset&&(i.lineDashOffset=t.lineDashOffset,e.lineDashOffset=t.lineDashOffset),i.lineJoin!=t.lineJoin&&(i.lineJoin=t.lineJoin,e.lineJoin=t.lineJoin),i.lineWidth!=t.lineWidth&&(i.lineWidth=t.lineWidth,e.lineWidth=t.lineWidth),i.miterLimit!=t.miterLimit&&(i.miterLimit=t.miterLimit,e.miterLimit=t.miterLimit),i.strokeStyle!=t.strokeStyle&&(i.strokeStyle=t.strokeStyle,e.strokeStyle=t.strokeStyle)):(e.lineCap=t.lineCap,e.setLineDash(t.lineDash),e.lineDashOffset=t.lineDashOffset,e.lineJoin=t.lineJoin,e.lineWidth=t.lineWidth,e.miterLimit=t.miterLimit,e.strokeStyle=t.strokeStyle,this.contextStrokeState_={lineCap:t.lineCap,lineDash:t.lineDash,lineDashOffset:t.lineDashOffset,lineJoin:t.lineJoin,lineWidth:t.lineWidth,miterLimit:t.miterLimit,strokeStyle:t.strokeStyle})}setContextTextState_(t){const e=this.context_,i=this.contextTextState_,n=t.textAlign?t.textAlign:Rt;i?(i.font!=t.font&&(i.font=t.font,e.font=t.font),i.textAlign!=n&&(i.textAlign=n,e.textAlign=n),i.textBaseline!=t.textBaseline&&(i.textBaseline=t.textBaseline,e.textBaseline=t.textBaseline)):(e.font=t.font,e.textAlign=n,e.textBaseline=t.textBaseline,this.contextTextState_={font:t.font,textAlign:n,textBaseline:t.textBaseline})}setFillStrokeStyle(t,e){if(!t)this.fillState_=null;else{const i=t.getColor();this.fillState_={fillStyle:at(i||H)}}if(!e)this.strokeState_=null;else{const i=e.getColor(),n=e.getLineCap(),o=e.getLineDash(),s=e.getLineDashOffset(),r=e.getLineJoin(),l=e.getWidth(),h=e.getMiterLimit(),a=o||nt;this.strokeState_={lineCap:n!==void 0?n:Pt,lineDash:this.pixelRatio_===1?a:a.map(c=>c*this.pixelRatio_),lineDashOffset:(s||st)*this.pixelRatio_,lineJoin:r!==void 0?r:vt,lineWidth:(l!==void 0?l:Gt)*this.pixelRatio_,miterLimit:h!==void 0?h:Bt,strokeStyle:at(i||At)}}}setImageStyle(t){let e;if(!t||!(e=t.getSize())){this.image_=null;return}const i=t.getPixelRatio(this.pixelRatio_),n=t.getAnchor(),o=t.getOrigin();this.image_=t.getImage(this.pixelRatio_),this.imageAnchorX_=n[0]*i,this.imageAnchorY_=n[1]*i,this.imageHeight_=e[1]*i,this.imageOpacity_=t.getOpacity(),this.imageOriginX_=o[0],this.imageOriginY_=o[1],this.imageRotateWithView_=t.getRotateWithView(),this.imageRotation_=t.getRotation();const s=t.getScaleArray();this.imageScale_=[s[0]*this.pixelRatio_/i,s[1]*this.pixelRatio_/i],this.imageWidth_=e[0]*i}setTextStyle(t){if(!t)this.text_="";else{const e=t.getFill();if(!e)this.textFillState_=null;else{const d=e.getColor();this.textFillState_={fillStyle:at(d||H)}}const i=t.getStroke();if(!i)this.textStrokeState_=null;else{const d=i.getColor(),g=i.getLineCap(),x=i.getLineDash(),_=i.getLineDashOffset(),p=i.getLineJoin(),S=i.getWidth(),y=i.getMiterLimit();this.textStrokeState_={lineCap:g!==void 0?g:Pt,lineDash:x||nt,lineDashOffset:_||st,lineJoin:p!==void 0?p:vt,lineWidth:S!==void 0?S:Gt,miterLimit:y!==void 0?y:Bt,strokeStyle:at(d||At)}}const n=t.getFont(),o=t.getOffsetX(),s=t.getOffsetY(),r=t.getRotateWithView(),l=t.getRotation(),h=t.getScaleArray(),a=t.getText(),c=t.getTextAlign(),u=t.getTextBaseline();this.textState_={font:n!==void 0?n:be,textAlign:c!==void 0?c:Rt,textBaseline:u!==void 0?u:Yt},this.text_=a!==void 0?Array.isArray(a)?a.reduce((d,g,x)=>d+=x%2?" ":g,""):a:"",this.textOffsetX_=o!==void 0?this.pixelRatio_*o:0,this.textOffsetY_=s!==void 0?this.pixelRatio_*s:0,this.textRotateWithView_=r!==void 0?r:!1,this.textRotation_=l!==void 0?l:0,this.textScale_=[this.pixelRatio_*h[0],this.pixelRatio_*h[1]]}}}const q=.5;function Gi(f,t,e,i,n,o,s,r,l){const h=n,a=f[0]*q,c=f[1]*q,u=jt(a,c);u.imageSmoothingEnabled=!1;const d=u.canvas,g=new vi(u,q,n,null,s,r,null),x=e.length,_=Math.floor((256*256*256-1)/x),p={};for(let y=1;y<=x;++y){const C=e[y-1],T=C.getStyleFunction()||i;if(!T)continue;let L=T(C,o);if(!L)continue;Array.isArray(L)||(L=[L]);const k=(y*_).toString(16).padStart(7,"#00000");for(let w=0,P=L.length;w<P;++w){const F=L[w],D=F.getGeometryFunction()(C);if(!D||!it(h,D.getExtent()))continue;const W=F.clone(),O=W.getFill();O&&O.setColor(k);const b=W.getStroke();b&&(b.setColor(k),b.setLineDash(null)),W.setText(void 0);const R=F.getImage();if(R){const M=R.getImageSize();if(!M)continue;const B=jt(M[0],M[1],void 0,{alpha:!1}),N=B.canvas;B.fillStyle=k,B.fillRect(0,0,N.width,N.height),W.setImage(new ui({img:N,anchor:R.getAnchor(),anchorXUnits:"pixels",anchorYUnits:"pixels",offset:R.getOrigin(),opacity:1,size:R.getSize(),scale:R.getScale(),rotation:R.getRotation(),rotateWithView:R.getRotateWithView()}))}const v=W.getZIndex()||0;let A=p[v];A||(A={},p[v]=A,A.Polygon=[],A.Circle=[],A.LineString=[],A.Point=[]);const X=D.getType();if(X==="GeometryCollection"){const M=D.getGeometriesArrayRecursive();for(let B=0,N=M.length;B<N;++B){const ot=M[B];A[ot.getType().replace("Multi","")].push(ot,W)}}else A[X.replace("Multi","")].push(D,W)}}const S=Object.keys(p).map(Number).sort(Wt);for(let y=0,C=S.length;y<C;++y){const T=p[S[y]];for(const L in T){const E=T[L];for(let k=0,w=E.length;k<w;k+=2){g.setStyle(E[k+1]);for(let P=0,F=t.length;P<F;++P)g.setTransform(t[P]),g.drawGeometry(E[k])}}}return u.getImageData(0,0,d.width,d.height)}function Bi(f,t,e){const i=[];if(e){const n=Math.floor(Math.round(f[0])*q),o=Math.floor(Math.round(f[1])*q),s=(Te(n,0,e.width-1)+Te(o,0,e.height-1)*e.width)*4,r=e.data[s],l=e.data[s+1],a=e.data[s+2]+256*(l+256*r),c=Math.floor((256*256*256-1)/t.length);a&&a%c===0&&i.push(t[a/c-1])}return i}const Yi=.5,Ae={Point:Ki,LineString:Zi,Polygon:qi,MultiPoint:Ui,MultiLineString:Hi,MultiPolygon:Ji,GeometryCollection:Vi,Circle:Ni};function Xi(f,t){return parseInt(kt(f),10)-parseInt(kt(t),10)}function Oe(f,t){const e=Pe(f,t);return e*e}function Pe(f,t){return Yi*f/t}function Ni(f,t,e,i,n){const o=e.getFill(),s=e.getStroke();if(o||s){const l=f.getBuilder(e.getZIndex(),"Circle");l.setFillStrokeStyle(o,s),l.drawCircle(t,i,n)}const r=e.getText();if(r&&r.getText()){const l=f.getBuilder(e.getZIndex(),"Text");l.setTextStyle(r),l.drawText(t,i)}}function Fe(f,t,e,i,n,o,s,r){const l=[],h=e.getImage();if(h){let u=!0;const d=h.getImageState();d==Tt.LOADED||d==Tt.ERROR?u=!1:d==Tt.IDLE&&h.load(),u&&l.push(h.ready())}const a=e.getFill();a&&a.loading()&&l.push(a.ready());const c=l.length>0;return c&&Promise.all(l).then(()=>n(null)),ji(f,t,e,i,o,s,r),c}function ji(f,t,e,i,n,o,s){const r=e.getGeometryFunction()(t);if(!r)return;const l=r.simplifyTransformed(i,n);if(e.getRenderer())ve(f,l,e,t,s);else{const a=Ae[l.getType()];a(f,l,e,t,s,o)}}function ve(f,t,e,i,n){if(t.getType()=="GeometryCollection"){const s=t.getGeometries();for(let r=0,l=s.length;r<l;++r)ve(f,s[r],e,i,n);return}f.getBuilder(e.getZIndex(),"Default").drawCustom(t,i,e.getRenderer(),e.getHitDetectionRenderer(),n)}function Vi(f,t,e,i,n,o){const s=t.getGeometriesArray();let r,l;for(r=0,l=s.length;r<l;++r){const h=Ae[s[r].getType()];h(f,s[r],e,i,n,o)}}function Zi(f,t,e,i,n){const o=e.getStroke();if(o){const r=f.getBuilder(e.getZIndex(),"LineString");r.setFillStrokeStyle(null,o),r.drawLineString(t,i,n)}const s=e.getText();if(s&&s.getText()){const r=f.getBuilder(e.getZIndex(),"Text");r.setTextStyle(s),r.drawText(t,i,n)}}function Hi(f,t,e,i,n){const o=e.getStroke();if(o){const r=f.getBuilder(e.getZIndex(),"LineString");r.setFillStrokeStyle(null,o),r.drawMultiLineString(t,i,n)}const s=e.getText();if(s&&s.getText()){const r=f.getBuilder(e.getZIndex(),"Text");r.setTextStyle(s),r.drawText(t,i,n)}}function Ji(f,t,e,i,n){const o=e.getFill(),s=e.getStroke();if(s||o){const l=f.getBuilder(e.getZIndex(),"Polygon");l.setFillStrokeStyle(o,s),l.drawMultiPolygon(t,i,n)}const r=e.getText();if(r&&r.getText()){const l=f.getBuilder(e.getZIndex(),"Text");l.setTextStyle(r),l.drawText(t,i,n)}}function Ki(f,t,e,i,n,o){const s=e.getImage(),r=e.getText(),l=r&&r.getText(),h=o&&s&&l?{}:void 0;if(s){if(s.getImageState()!=Tt.LOADED)return;const a=f.getBuilder(e.getZIndex(),"Image");a.setImageStyle(s,h),a.drawPoint(t,i,n)}if(l){const a=f.getBuilder(e.getZIndex(),"Text");a.setTextStyle(r,h),a.drawText(t,i,n)}}function Ui(f,t,e,i,n,o){const s=e.getImage(),r=s&&s.getOpacity()!==0,l=e.getText(),h=l&&l.getText(),a=o&&r&&h?{}:void 0;if(r){if(s.getImageState()!=Tt.LOADED)return;const c=f.getBuilder(e.getZIndex(),"Image");c.setImageStyle(s,a),c.drawMultiPoint(t,i,n)}if(h){const c=f.getBuilder(e.getZIndex(),"Text");c.setTextStyle(l,a),c.drawText(t,i,n)}}function qi(f,t,e,i,n){const o=e.getFill(),s=e.getStroke();if(o||s){const l=f.getBuilder(e.getZIndex(),"Polygon");l.setFillStrokeStyle(o,s),l.drawPolygon(t,i,n)}const r=e.getText();if(r&&r.getText()){const l=f.getBuilder(e.getZIndex(),"Text");l.setTextStyle(r),l.drawText(t,i,n)}}class zi extends fi{constructor(t){super(t),this.boundHandleStyleImageChange_=this.handleStyleImageChange_.bind(this),this.animatingOrInteracting_,this.hitDetectionImageData_=null,this.clipped_=!1,this.renderedFeatures_=null,this.renderedRevision_=-1,this.renderedResolution_=NaN,this.renderedExtent_=Nt(),this.wrappedRenderedExtent_=Nt(),this.renderedRotation_,this.renderedCenter_=null,this.renderedProjection_=null,this.renderedPixelRatio_=1,this.renderedRenderOrder_=null,this.renderedFrameDeclutter_,this.replayGroup_=null,this.replayGroupChanged=!0,this.clipping=!0,this.targetContext_=null,this.opacity_=1}renderWorlds(t,e,i){const n=e.extent,o=e.viewState,s=o.center,r=o.resolution,l=o.projection,h=o.rotation,a=l.getExtent(),c=this.getLayer().getSource(),u=this.getLayer().getDeclutter(),d=e.pixelRatio,g=e.viewHints,x=!(g[Ft.ANIMATING]||g[Ft.INTERACTING]),_=this.context,p=Math.round(Ct(n)/r*d),S=Math.round(gi(n)/r*d),y=c.getWrapX()&&l.canWrapX(),C=y?Ct(a):null,T=y?Math.ceil((n[2]-a[2])/C)+1:1;let L=y?Math.floor((n[0]-a[0])/C):0;do{let E=this.getRenderTransform(s,r,0,d,p,S,L*C);e.declutter&&(E=E.slice(0)),t.execute(_,[_.canvas.width,_.canvas.height],E,h,x,i===void 0?gt:i?We:Wi,i?u&&e.declutter[u]:void 0)}while(++L<T)}setDrawContext_(){this.opacity_!==1&&(this.targetContext_=this.context,this.context=jt(this.context.canvas.width,this.context.canvas.height,Re))}resetDrawContext_(){if(this.opacity_!==1){const t=this.targetContext_.globalAlpha;this.targetContext_.globalAlpha=this.opacity_,this.targetContext_.drawImage(this.context.canvas,0,0),this.targetContext_.globalAlpha=t,_i(this.context),Re.push(this.context.canvas),this.context=this.targetContext_,this.targetContext_=null}}renderDeclutter(t){!this.replayGroup_||!this.getLayer().getDeclutter()||this.renderWorlds(this.replayGroup_,t,!0)}renderDeferredInternal(t){this.replayGroup_&&(this.replayGroup_.renderDeferred(),this.clipped_&&this.context.restore(),this.resetDrawContext_())}renderFrame(t,e){const i=t.layerStatesArray[t.layerIndex];this.opacity_=i.opacity;const n=t.viewState;this.prepareContainer(t,e);const o=this.context,s=this.replayGroup_;let r=s&&!s.isEmpty();if(!r&&!(this.getLayer().hasListener(ke.PRERENDER)||this.getLayer().hasListener(ke.POSTRENDER)))return null;if(this.setDrawContext_(),this.preRender(o,t),n.projection,this.clipped_=!1,r&&i.extent&&this.clipping){const l=xi(i.extent);r=it(l,t.extent),this.clipped_=r&&!bt(l,t.extent),this.clipped_&&this.clipUnrotated(o,t,l)}return r&&this.renderWorlds(s,t,this.getLayer().getDeclutter()?!1:void 0),!t.declutter&&this.clipped_&&o.restore(),this.postRender(o,t),this.renderedRotation_!==n.rotation&&(this.renderedRotation_=n.rotation,this.hitDetectionImageData_=null),t.declutter||this.resetDrawContext_(),this.container}getFeatures(t){return new Promise(e=>{if(this.frameState&&!this.hitDetectionImageData_&&!this.animatingOrInteracting_){const i=this.frameState.size.slice(),n=this.renderedCenter_,o=this.renderedResolution_,s=this.renderedRotation_,r=this.renderedProjection_,l=this.wrappedRenderedExtent_,h=this.getLayer(),a=[],c=i[0]*q,u=i[1]*q;a.push(this.getRenderTransform(n,o,s,q,c,u,0).slice());const d=h.getSource(),g=r.getExtent();if(d.getWrapX()&&r.canWrapX()&&!bt(g,l)){let x=l[0];const _=Ct(g);let p=0,S;for(;x<g[0];)--p,S=_*p,a.push(this.getRenderTransform(n,o,s,q,c,u,S).slice()),x+=_;for(p=0,x=l[2];x>g[2];)++p,S=_*p,a.push(this.getRenderTransform(n,o,s,q,c,u,S).slice()),x-=_}this.hitDetectionImageData_=Gi(i,a,this.renderedFeatures_,h.getStyleFunction(),l,o,s,Oe(o,this.renderedPixelRatio_))}e(Bi(t,this.renderedFeatures_,this.hitDetectionImageData_))})}forEachFeatureAtCoordinate(t,e,i,n,o){if(!this.replayGroup_)return;const s=e.viewState.resolution,r=e.viewState.rotation,l=this.getLayer(),h={},a=function(g,x,_){const p=kt(g),S=h[p];if(S){if(S!==!0&&_<S.distanceSq){if(_===0)return h[p]=!0,o.splice(o.lastIndexOf(S),1),n(g,l,x);S.geometry=x,S.distanceSq=_}}else{if(_===0)return h[p]=!0,n(g,l,x);o.push(h[p]={feature:g,layer:l,geometry:x,distanceSq:_,callback:n})}};let c;const u=[this.replayGroup_],d=this.getLayer().getDeclutter();return u.some(g=>c=g.forEachFeatureAtCoordinate(t,s,r,i,a,d&&e.declutter[d]?e.declutter[d].all().map(x=>x.value):null)),c}handleFontsChanged(){const t=this.getLayer();t.getVisible()&&this.replayGroup_&&t.changed()}handleStyleImageChange_(t){this.renderIfReadyAndVisible()}prepareFrame(t){const e=this.getLayer(),i=e.getSource();if(!i)return!1;const n=t.viewHints[Ft.ANIMATING],o=t.viewHints[Ft.INTERACTING],s=e.getUpdateWhileAnimating(),r=e.getUpdateWhileInteracting();if(this.ready&&!s&&n||!r&&o)return this.animatingOrInteracting_=!0,!0;this.animatingOrInteracting_=!1;const l=t.extent,h=t.viewState,a=h.projection,c=h.resolution,u=t.pixelRatio,d=e.getRevision(),g=e.getRenderBuffer();let x=e.getRenderOrder();x===void 0&&(x=Xi);const _=h.center.slice(),p=oe(l,g*c),S=p.slice(),y=[p.slice()],C=a.getExtent();if(i.getWrapX()&&a.canWrapX()&&!bt(C,t.extent)){const O=Ct(C),b=Math.max(Ct(p)/2,O);p[0]=C[0]-b,p[2]=C[2]+b,pi(_,a);const R=Si(y[0],a);R[0]<C[0]&&R[2]<C[2]?y.push([R[0]+O,R[1],R[2]+O,R[3]]):R[0]>C[0]&&R[2]>C[2]&&y.push([R[0]-O,R[1],R[2]-O,R[3]])}if(this.ready&&this.renderedResolution_==c&&this.renderedRevision_==d&&this.renderedRenderOrder_==x&&this.renderedFrameDeclutter_===!!t.declutter&&bt(this.wrappedRenderedExtent_,p))return Zt(this.renderedExtent_,S)||(this.hitDetectionImageData_=null,this.renderedExtent_=S),this.renderedCenter_=_,this.replayGroupChanged=!1,!0;this.replayGroup_=null;const T=new Oi(Pe(c,u),p,c,u);let L;for(let O=0,b=y.length;O<b;++O)i.loadFeatures(y[O],c,a);const E=Oe(c,u);let k=!0;const w=(O,b)=>{let R;const v=O.getStyleFunction()||e.getStyleFunction();if(v&&(R=v(O,c)),R){const A=this.renderFeature(O,E,R,T,L,this.getLayer().getDeclutter(),b);k=k&&!A}},P=mi(p),F=i.getFeaturesInExtent(P);x&&F.sort(x);for(let O=0,b=F.length;O<b;++O)w(F[O],O);this.renderedFeatures_=F,this.ready=k;const D=T.finish(),W=new Ai(p,c,u,i.getOverlaps(),D,e.getRenderBuffer(),!!t.declutter);return this.renderedResolution_=c,this.renderedRevision_=d,this.renderedRenderOrder_=x,this.renderedFrameDeclutter_=!!t.declutter,this.renderedExtent_=S,this.wrappedRenderedExtent_=p,this.renderedCenter_=_,this.renderedProjection_=a,this.renderedPixelRatio_=u,this.replayGroup_=W,this.hitDetectionImageData_=null,this.replayGroupChanged=!0,!0}renderFeature(t,e,i,n,o,s,r){if(!i)return!1;let l=!1;if(Array.isArray(i))for(let h=0,a=i.length;h<a;++h)l=Fe(n,t,i[h],e,this.boundHandleStyleImageChange_,o,s,r)||l;else l=Fe(n,t,i,e,this.boundHandleStyleImageChange_,o,s,r);return l}}class $i extends yi{constructor(t){super(t)}createRenderer(){return new zi(this)}}function Qi(f){const t=$i;return Ti.createElement(Ci,{...f,layerConstructor:t})}const tn=[{title:"Update fill color",property:"--data-source-polygon-fill-color",defaultValue:"#ff0000",type:"color"},{title:"Update stroke color",property:"--data-source-polygon-stroke-color",defaultValue:"#000000",type:"color"},{title:"Update stroke width",property:"--data-source-polygon-stroke-width",type:"number",defaultValue:"2"}],sn=()=>J.jsxs(J.Fragment,{children:[J.jsx("section",{style:{width:"300px",height:"300px"},children:J.jsx(Ii,{className:"data-source-example-map",children:J.jsx(Qi,{fitViewToData:!0,url:"/react-geojson-mapsample.geojson"})})}),J.jsxs("section",{children:[J.jsx("h3",{children:"Update CSS Variables"}),J.jsx("div",{className:"data-source-example-options",children:tn.map((f,t)=>J.jsxs("div",{className:"data-source-example-option",children:[J.jsx("label",{children:f.title}),J.jsx("input",{defaultValue:f.defaultValue,title:f.title,type:f.type,onChange:e=>{document.querySelector(".data-source-example-map").style.setProperty(f.property,e.target.value+(f.type==="number"?"px":""))}})]},t))})]})]});export{sn as default};
